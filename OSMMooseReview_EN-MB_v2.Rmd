---
title: "Knowledge Assessment of Moose (Alces alces) in Alberta's Oil Sands Region"
author: "Eric Neilson, Marcus Becker, Erin Bayne"
date: "February 25, 2019"
output: 
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_float: true
    code_folding: hide
    highlight: zenburn
    theme: readable
  pdf_document:
    toc: yes
fontsize: 10.5pt
urlcolor: blue
---

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE}

# Install packages
library(tidyverse)
library(sf)
library(leaflet)
library(leaflet.extras)
library(rgeos)
library(tmap) 
library(tmaptools)
library(plotly)
library(DT)
library(Hmisc)
library(knitr)
library(colourvalues)

knitr::opts_chunk$set(out.width='80%', fig.align = "center")

```

# Executive Summary

***

We reviewed technical reports and peer-reviewed articles to assess the state of
knowledge of moose in Alberta's Oil Sands Region (OSR). Our intention was to
elucidate what is known concerning moose in the region, and in particular, what
the effect of oil and gas extraction has been on the moose population. We 
reviewed 33 documents (20 reports, 12 peer-reviewed articles, and 1 thesis) and
extracted relevant estimates of moose population state variables. In addition, 
we utilized data from the Alberta Biodiversity Monitoring Institute's 
(ABMI) camera monitoring program to corroborate this information and provide 
additional context around moose population density and relative abundance in the
OSR.

The compiled metrics were used to construct estimates or describe the state of 
the moose population in the OSR. Average moose population density, among the 
Wildlife Management Units (WMUs) sampled, in the OSR is 0.17 per km2. We 
uncovered no clear trend in moose density across years or WMUs, although the 
sample size was often small. Similarly, moose calf:cow and bull:cow ratios were
quite variable but also exhibited no clear trend in time or space. According to
several studies, moose were sensitive to human disturbance, generally exhibiting
low use and avoidance of human features across multiple scales of measurement. 

In conclusion, moose are well studied in the OSR. Whereas no estimates of have 
revealed a downward trend in population density, due to the behavioural 
responses of moose to human disturbance, we recommend further work exploring 
changes in moose density at smaller scales in proximity to human disturbance.

# Study Area

***

In this report, the study area is defined as that of the OSR of Alberta and all 
the WMUs that intersect it geographically (Figure 1).   

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE, out.width="60%", fig.cap="Figure 1. Study Area - Oil Sands Region boundary outlined in red."}

# Import spatial data from shapefiles located in SpatialData folder

# Oil Sands Region (OSR)
ab_osr <- st_read("./SpatialData/AB_OSR.shp", 
                  stringsAsFactors = FALSE, quiet = TRUE)
# WMUs intersected with the OSR
ab_wmu <- st_read("./SpatialData/AB_WMU-OSR-Intersect.shp", 
                  stringsAsFactors = FALSE, quiet = TRUE)
# Provincial polygon
ab_prov <- st_read("./SpatialData/AB_Prov.shp", 
                  stringsAsFactors = FALSE, quiet = TRUE)
# ABMI 1km pixels
pixel_1km <- st_read("./SpatialData/ABMI_Grid_1KM_OSM_v3.shp",
                     stringsAsFactors = FALSE, quiet = TRUE)

# Clean up and projection
ab_wmu <- ab_wmu %>%
  separate(WMUNIT_COD, into = c("zeroes", "WMU"), sep = 2, remove = FALSE) %>%
  select(-c(zeroes, Shape_STAr, Shape_STLe)) %>%
  # st_transform("+init=epsg:4326") %>%
  st_cast("POLYGON")
  
# ab_prov <- st_transform(ab_prov, "+init=epsg:4326")
# ab_osr <- st_transform(ab_osr, "+init=epsg:4326")

# Create static map (tmap)

tm_map_aoi <- ab_prov %>%
  tm_shape() +
    tm_borders(col = "black") +
  tm_shape(ab_wmu) +
    tm_fill(col = "grey90") +
    tm_borders(col = "black", lwd = 1) +
  tm_shape(ab_osr) +
    tm_borders(col = "brown", lwd = 5) +
  tm_compass(type = "4star", size = 2, position = c("left", "bottom")) +
  tm_scale_bar(position = c("left", "bottom")) +
  tm_layout(title = "", title.size = 1,
            legend.title.size = 1, frame = FALSE)

# tm_map_aoi

# tmap_save(tm_map_aoi, filename = "./tmap_png/aoi.png", width = 4)

include_graphics("./png_files/aoi.png")

```


# Data Sources

***

Summarize data sources included in this review.

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE}

# Import raw moose data

# ABMI densities
df_abmi <- read_csv("./Data/Raw/ABMIMetrics.csv")
# Data from Government reports
df_all <- read_csv("./Data/Raw/Metrics.csv")
# Density data from more recent Government reports
df_gov_recent <- read_csv("./Data/Raw/OSM_Ungulate_Survey_Data_2013-2018_Density.csv")
# ABMI relative abundance predictions
abmi_pred <- read_csv("./Data/Raw/Moose_km2-summary.csv")

```

# Results

***

## Population

### Density

We included density estimates from 19 government reports. The average density of
moose within WMUs of the OSR between 2014 and 2018 (the interval over which the
Government of Alberta began using the distance sampling method for aerial 
surveys) is 0.17 animals per km^2. From 1993 to 2014, when the random 
block/Gasaway method was used, moose density averaged 0.18 per km^2.

Figure 1 below display the mean moose density across surveyed WMUs reported in
Government of Alberta aerial ungulate survey reports. The error bars are one
standard error. One year with an extreme density outlier (WMU 515 in 2004 with
1.2 animals per km^2) was removed from the figure for graphical clarity. 

```{r include = TRUE, echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE}

df_dens1 <- df_all %>%
  filter(Response == "Density",
         Species == "Moose",
         !is.na(WMU),
         !WMU == "506;510" & !WMU == "530 North" & !WMU == "530 South") %>%
  mutate(WMU = as.numeric(str_replace_all(WMU, "530 Full", "530"))) %>%
  select(WMU, StartYear, MetricNum, CIL, CIU) %>%
  rename(Survey_Year = StartYear,
         Density = MetricNum) %>%
  full_join(df_gov_recent, by = c("WMU", "Survey_Year")) %>%
  # WMUs 258, 511, and 519 have different density estimates. 
  mutate(Density = if_else(is.na(Density.y), Density.x, Density.y)) %>%
  select(-c(Density.x, Density.y)) %>%
  distinct() %>%
  mutate(WMU = as.character(WMU))

df_dens2 <- df_dens1 %>%
  group_by(Survey_Year) %>%
  summarise(mean_dens = mean(Density),
            count = n(),
            se = sd(Density)/sqrt(count))

```

```{r include = TRUE, echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE, fig.cap = c("Plot 1", "Plot 2")}

dens1 <- df_dens1 %>%
  filter(Density < 1) %>%
  ggplot(aes(x = Survey_Year, y = Density, colour = WMU)) +
  geom_line() +
  geom_point(size = 2.5) +
  scale_x_continuous(breaks = c(1995, 2000, 2005, 2010, 2015)) +
  # labs(y = expression(Density~(per~km^2)), x = "") +
  labs(y = "Moose Density per square km", x = "") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 10))

# dens1

dens1_p <- ggplotly(dens1)

dens1_p

dens2 <- df_dens2 %>%
  filter(mean_dens < 1.2) %>%
  ggplot(aes(x = Survey_Year, y = mean_dens)) +
  geom_point(aes(size = count)) +
  geom_errorbar(aes(ymin = mean_dens - se, ymax = mean_dens + se, 
                    width = 0.1)) +
  scale_x_continuous(breaks = c(1995, 2000, 2005, 2010, 2015)) +
  labs(y = expression(Density~(per~km^2)), x = "",
       size = "Number of WMUs Surveyed") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 10),
        legend.position = "bottom")
        # panel.border = element_blank(),
        # panel.grid.minor = element_blank()) 
  
dens2

# dens2_p <- ggplotly(dens2)

# dens2_p

# Do we want to include a table here simply showing the number of times each
# WMU has been surveyed?

tab1 <- df_dens1 %>%
  group_by(WMU) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

```

The map below displays the moose density associated with each WMU in the study 
region, calculated from the most recent aerial survey undertaken. 

```{r include = TRUE, echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE}

df_dens_curr <- df_dens1 %>%
  group_by(WMU) %>%
  slice(which.max(Survey_Year)) %>%
  mutate(Method = ifelse(Survey_Year >= 2014, 
                         "Distance Sampling",
                         "Random Block/Gasaway")) %>%
  ungroup()

ab_wmu_dens <- ab_wmu %>%
  left_join(df_dens_curr, by = "WMU") %>%
  select(WMUNIT_NAM, WMU, Survey_Year:Method)

# Static map

# Using ggplot
gg_map_dens <- ab_wmu_dens %>%
  ggplot() +
  geom_sf(aes(fill = Density)) +
  geom_sf_label(aes(label = WMU)) + 
  coord_sf(datum = NA) +
  theme_void()
  
# gg_map_dens

legend_title_dens <- expression("Density (animals per km"^2*")")

# Using tmap
tm_map_dens <- ab_wmu_dens %>%
  tm_shape() +
  tm_fill(col = "Density",
          style = "cont",
          colorNA = "grey60",
          textNA = "Missing",
          title = legend_title_dens) +
  tm_borders(col = "black") +
  tm_text("WMU", size = 0.65) +
  tm_compass(type = "4star", size = 2, 
             position = c("left", "bottom")) +
  tm_scale_bar(position = c("left", "bottom"))

# tm_map_dens

# tmap_save(tm_map_dens, filename = "./tmap_png/dens.png", height = 6)

include_graphics("./png_files/dens.png")

```

The interactive map below displays the moose density associated with each WMU in 
the study region, calculated from the most recent aerial survey undertaken.

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE, out.width='100%', fig.height=10}

# Interactive leaflet map

# Set projections
ab_prov_proj <- st_transform(ab_prov, "+init=epsg:4326")
ab_osr_proj <- st_transform(ab_osr, "+init=epsg:4326")
ab_wmu_dens_proj <- st_transform(ab_wmu_dens, "+init=epsg:4326")

# Define colours
pal_1 <- colorNumeric(palette = "YlOrBr", domain = ab_wmu_dens$Density)

# Create df of WMU centroids for labels
df_centers <- ab_wmu_dens %>%
  st_centroid() %>%
  as_Spatial()

# Create leaflet map
map_1 <-
ab_prov_proj %>%
  leaflet() %>%
  addTiles() %>%
  addProviderTiles("Stamen.TerrainBackground") %>%
  addProviderTiles("Esri.WorldImagery", group = "Imagery") %>%
  addFullscreenControl() %>%
  addResetMapButton() %>%
  addScaleBar(position = "bottomright", 
              options = scaleBarOptions(imperial = FALSE)) %>%
  setView(lng = -113.89, lat = 56.53, zoom = 6) %>%
  addMapPane(name = "OSR Boundary", zIndex = 420) %>%
  addMapPane(name = "Other", zIndex = 410) %>%
  
  # Polygon layers
  addPolygons(color = "#070707", weight = 1, smoothFactor =  0.2, 
              opacity = 2.0) %>%
  
  addPolylines(data = ab_osr_proj, color = "#070707", weight = 3,
              smoothFactor = 0.2, opacity = 3.0, fill = FALSE,
              group = "OSR Boundary",
              options = leafletOptions(pane = "OSR Boundary")) %>%
  
  addPolygons(data = ab_wmu_dens_proj, 
              color = "#070707", weight = 0.8,
              smoothFactor = 0.5, opacity = 1.0, fillOpacity = 0.75, 
              fillColor = ~ pal_1(Density), 
              popup = paste("WMU Name:", 
                            "<b>", ab_wmu_dens_proj$WMUNIT_NAM, "</b>", "<br>",
                            "WMU Code:", 
                            "<b>", ab_wmu_dens_proj$WMU, "</b>", "<br>",
                            "Moose Density:", 
                            "<b>", ab_wmu_dens_proj$Density, "</b>", "per km2", 
                            "<br>", 
                            "<br>",
                            "<i>", "Last surveyed in", 
                            ab_wmu_dens_proj$Survey_Year, "<i>"),
              group = "Moose Density - Aerial Surveys",
              options = leafletOptions(pane = "Other")) %>%
  
  # Labels
  addLabelOnlyMarkers(data = df_centers, label = ~WMUNIT_NAM,
                      group = "WMU Name Labels",
                      labelOptions = labelOptions(
                        noHide = TRUE,
                        textOnly = FALSE,
                        textsize = "10px",
                        opacity = 1,
                        offset = c(0,0)
                      )) %>%
  
  # Legend layer
  addLegend(data = ab_wmu_dens_proj, position = "bottomleft", pal = pal_1, 
            bins = c(0.1, 0.2, 0.3, 0.4, 0.5),
            values = ~Density, na.label = "No Data", 
            title = "Moose Density per km2",
            opacity = 1.0, group = "Moose Density - Aerial Surveys") %>%
  
  # Layers control
  addLayersControl(overlayGroups = c("Imagery",
                                     "Moose Density - Aerial Surveys",
                                     "WMU Name Labels",
                                     "OSR Boundary"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
  
  hideGroup(c("Imagery", "WMU Name Labels"))

map_1

```

The ABMI uses remotely deployed cameras (RCs) to assess the occurrence and 
density of mammals across Alberta. The RCs are deployed at sampling sites that 
are distributed along a 20 km systematic grid across the province. Four cameras
are deployed per site, two with lure and two without lure. In the OSR, 20% of 
sites are visited each year. RCs are relatively easy and cost-effective to 
deploy and allow for spatially explicit analysis of animal densities and 
occupancy. RCs also have the ability to provide more detailed information such 
as sex- and age-ratios, body condition, and behaviour as well as community level
metrics such as species richness and phenology (although the ABMI does not 
currently collect this information from RCs).

The ABMI estimates the density of mammals such as moose from RC data using the 
cumulative residency time (CRT) that the species is captured on camera. This 
method estimates density by assuming that animals use (and move across) the 
sampled area randomly such that the total residency time in any given location 
is a function of the number of animals in a fixed area. In addition, RCs can 
provide increased spatial resolution in the estimation of density when compared
to Government of Alberta aerial surveys, including support for more detailed
habitat modeling and predicted relative abundance across a heterogeneous
landscape. However, the widespread use of RCs in Alberta for ecological purposes
is still in a nascent phase, and questions remain about the precision, accuracy,
and required sampling effort of CRT analysis. 

Here we compare the ABMI's CRT-derived moose density estimates to those 
estimated by the Government of Alberta using distance sampling (i.e., aerial 
surveys conducted since 2014). We used the WMU as the sample unit, allowing us 
to compare the density estimate directly over the years 2014-2018. The ABMI 
estimates were calculated using all RC data from the years 2015-2017, whereas 
aerial survey density estimates were calculated from a singe year sample within 
the the five year time period. There were fourteen WMUs in the OSR that we were 
able to obtain moose density estimates from both sources. Table below displays
the results, and corresponding confidence intervals in estimates, and Figure 
presents the relationship between each set of density estimates.

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE}

df_abmi1 <- df_abmi %>%
  mutate(CI_abmi = paste(CIL, CIU, sep = ", ")) %>%
  rename(Density_abmi = Density) %>%
  mutate(Survey_Year = NA) %>%
  na_if("NA, NA") %>%
  select(-c(CIL, CIU))

df_dens_tab <- df_dens_curr %>%
  filter(Method == "Distance Sampling") %>%
  mutate(WMU = as.numeric(WMU),
         CIL = round(CIL, digits = 2),
         CIU = round(CIU, digits = 2),
         CI_gov = paste(CIL, CIU, sep = ", "),
         Density = round(Density, digits = 2),
         SampleSize = NA) %>%
  na_if("NA, NA") %>%
  rename(Density_gov = Density,
         Source = Method) %>%
  select(WMU, Source, Survey_Year, Density_gov, CI_gov, SampleSize) %>%
  bind_rows(df_abmi1) %>%
  mutate(Source = str_replace_all(Source, "Distance Sampling", "GoA")) %>%
  arrange(WMU) %>%
  mutate(WMU = as.character(WMU))

datatable(data = df_dens_tab, filter = "top", rownames = FALSE,
          caption = "Table 1. WMU-level Density Estimates Using Data from Aerial
          Surveys and ABMI Remote Cameras",
          class = 'cell-border-stripe',
          colnames = c("WMU", "Source", "Aerial Survey Year", 
                       "Density (Aerial)", "90% CI - Aerial",
                       "ABMI Camera Deployments", "Density (ABMI)", 
                       "90% CI - ABMI"),
          options = list(pageLength = 10, scrollX = TRUE))

```
<br>
<br>
```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE, fig.cap="Figure. Density Comparison"}
  
# Prepare density data for comparison between sources
df_dens_comp <- df_dens_curr %>%
  filter(Method == "Distance Sampling") %>%
  mutate(WMU = as.numeric(WMU)) %>%
  rename(Density_gov = Density) %>%
  select(WMU, Density_gov) %>%
  full_join(df_abmi, by = "WMU") %>%
  filter(!is.na(Density_gov) & !is.na(Density)) %>%
  rename(Density_abmi = Density) %>%
  select(WMU, Density_gov, Density_abmi)
  
# Create scatterplot of density estimates
dens3 <- df_dens_comp %>%
  # Filter out outlier
  filter(Density_abmi < 4) %>%
  ggplot(aes(x = Density_gov, y = Density_abmi)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  theme_classic() +
  labs(x = "Density Estimated via Aerial Surveys",
       y = "Density Estimated via ABMI RCs")

dens3

```

The ABMI CRT density estimates are generally higher than those produced by 
aerial survey distance sampling, but are weakly correlated. In addition, the 
ABMI estimates of moose density exhibit higher uncertainty, as shown by wider
90% confidence intervals. This uncertainty is related to the number of cameras
placed in each WMU (Deployments in the above table), such that confidence 
increases when more cameras are available in a sampling unit. Most of the WMUs
in the OSR have less than 100 deployments, and therefore would be expected to 
have moose density confidence limits that are as wide as the mean (i.e., +/- 50%
of the mean if they were symmetrical) after one complete monitoring rotation 
(Huggard, 2019). This means that only large changes in moose population would be
detected with statistical confidence. However, across the entire OSR, where 
there were between 174-268 ABMI RC deployments per year between 2015 and 2017,
confidence intervals are smaller. For the entire OSR, moose densites were 0.68,
0.54, and 0.41 animals per km$^2$ in 2015, 2016, and 2017, respectively [^1].

[^1]: This decline is likely due to cameras being put out in the field 
increasingly early each year. This means more sampling in the winter, which 
generally leads to less detections and lower density estimates (Huggard, 2019). 
The intent is to develop a seasonal correction procedure once the 2018 RC data 
arrives. 

According to Huggard (2019), moose density estimates from RCs are likely to be 
biased upwards. The first reason for this is a practical element of using RCs: 
cameras are usually placed in small openings so that they are not obscured by 
vegetation. However, moose tend to use these areas preferentially for foraging 
(at least in the summer), leading to overestimates of density. The second reason
is that moose are also attracted to the cameras (lure or no lure). In order to 
get accurate absolute density estimates from RCs, a calibration procedure using
other methods (such as aerial surveys) will likely be required. However, RC data
can still be useful as relative abundance estimates, and be used for habitat 
modeling (see section on Distribution) and for long-term trend analysis. 

### Lambda

Only one document (Rolley and Keith, 1980) estimated the geometric rate of 
increase of moose populations in northeastern Alberta directly. Whereas the
study area was not within the OSR, we present the values here as a historical
reference. In Rochester, Alberta, which was the study area, the geometric rate 
of increase in moose was 1.24 and 1.03 in 1965 and 1979, respectively. 

We calculated lambda for 9 WMUs from 13 Government of Alberta reports between 
1993 and 2013 (Table). Across all WMUs and years, mean lambda was 1.03. As 
should be expected given the stability of moose density in Northeastern Alberta,
lambda is near one for all WMUs with reported metrics of density across multiple
years (Table) but varies by WMU, with growth rates generally decreasing with
latitute. 

```{r include = TRUE, echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE}

# Calculating lambda

# Included all aerial surveys, with both methods. This might not be correct.

df_lamb1 <- df_dens1 %>%
  group_by(WMU) %>%
  add_tally() %>%
  # Filter out WMUs that have not been surveyed at least twice
  filter(n > 1) %>%
  arrange(WMU, Survey_Year) %>%
  # Calculate lambda
  mutate(Ndelta = Density - lag(Density),
         Tdelta = Survey_Year - lag(Survey_Year),
         Adelta = Ndelta / Tdelta,
         Delta = lag(Density) + Adelta,
         Lambda = Delta / lag(Density)) 

df_nsurveys <- df_dens1 %>%
  group_by(WMU) %>%
  add_tally() %>%
  select(WMU, n) %>%
  distinct()

df_lamb2 <- df_lamb1 %>%
  group_by(WMU) %>%
  # Calculate average lambda for WMUs with more than one value
  summarise(Lambda_u = mean(Lambda, na.rm = TRUE)) %>%
  left_join(df_nsurveys, by = "WMU") %>%
  mutate(Lambda_u = round(Lambda_u, digits = 2))

# Join lambda information to WMU polygons
ab_wmu_lamb <- ab_wmu %>%
  left_join(df_lamb2, by = "WMU")

# Create static map of lambda

legend_title_lamb <- "Lambda"

tm_map_lamb <- ab_wmu_lamb %>%
  tm_shape() +
    tm_fill(col = "Lambda_u", 
            palette = "-RdBu", 
            midpoint = 1,
            style = "cont",
            colorNA = "grey60",
            textNA = "Missing",
            title = legend_title_lamb) +
    tm_borders(col = "black") +
    tm_text("WMU", size = 0.65) +
  tm_compass(type = "4star", size = 2, 
             position = c("left", "bottom")) +
  tm_scale_bar(position = c("left", "bottom"))

# tm_map_lamb

# tmap_save(tm_map_lamb, filename = "./tmap_png/lamb.png", height = 6)

include_graphics("./png_files/lamb.png")

datatable(data = df_lamb2,
          class = 'cell-border stripe',
          colnames = c("WMU", "Lambda",
                       "Number of Surveys"),
          rownames = FALSE,
          width = 500,
          options = list(
            columnDefs = list(list(className = 'dt-left', targets = 1)),
            pageLength = 14,
            dom = 't')) 

```

### Demographics

Of the documents we reviewed, 22 reported on either calf:cow or bull:cow ratios
(or both). Including multiple values from Government of Alberta reports provided
a total of 116 data points of either sex or calf ratios. 

Across all years and WMUs for which ratios were reported,

+ The mean calf:cow ratio was **0.52**;
+ The mean bull:cow ratio was **0.51**.

As shown in Figures, no clear trend in sex of calf ratios was observed either
temporally or spatially.

Figure of ratios over time?
Map of ratios -> same diverging colour scale. 

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE}

# Prepare df of demographic data
df_demo <- df_all %>%
  filter(Response == "CalfCow" | Response == "MaleFemale",
         Species == "Moose",
         !is.na(WMU)) %>%
  separate(MetricText, into = c("numerator", "denominator"), sep = ":") %>%
  mutate(numerator = as.numeric(numerator), 
         denominator = as.numeric(denominator),                                     
         ratio = numerator / denominator) %>%
  mutate(ratio = if_else(is.na(ratio), MetricNum, ratio)) %>%
  select(WMU, StartYear, Response, ratio) %>%
  filter(!WMU == "518;519;529;530;531" & !WMU == "506;510" &
         !WMU == "518;530;531" & !WMU == "530 North" & !WMU == "530 South") %>%
  mutate(WMU = as.numeric(if_else(WMU =="530 Full", "530", WMU)),
         Response = str_replace_all(Response, "MaleFemale", "Bull:Cow"),
         Response = str_replace_all(Response, "CalfCow", "Calf:Cow"))

df_demo1 <- df_demo %>%
  # Important to group by both start year and reponse in order to retain two
  # observations for each year of data (CalfCow & MaleFemale)
  group_by(StartYear, Response) %>%
  # Calculate average ratios for each year, across WMU
  summarise(ratio_u = mean(ratio))

# Create scatterplot of demographics (ratios) over time, averaged across WMU

demo1 <- df_demo1 %>%
  mutate(Response = factor(Response, levels = c("Calf:Cow", "Bull:Cow"))) %>%
  ggplot(aes(x = StartYear, y = ratio_u)) +
  geom_point() +
  # Facet wrap to visualize CowCalf and MaleFemale separately. 
  facet_wrap(~ Response) +
  # Add trendline. Maybe "lm" method is better here?
  geom_smooth(method = "loess", se = FALSE) +
  scale_x_continuous(breaks = c(1995, 2000, 2005, 2010, 2015)) +
  labs(y = "Ratio (per Cow)",
       x = "") +
  theme_bw() +
  theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 10),
        panel.grid.minor = element_blank())

demo1

```

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE, out.width='100%'}

# Create static map of demographics

# Prepare df of most recent datapoints for each WMU
df_demo2 <- df_demo %>%
  # Important to group by both WMU and reponse in order to retain two
  # observations for each WMU (CalfCow & MaleFemale)
  group_by(WMU, Response) %>%
  slice(which.max(StartYear))

# Prepare colors (Blues)
c1 <- c('#f7fbff','#deebf7','#c6dbef',
         '#9ecae1','#6baed6','#4292c6',
         '#2171b5','#08519c','#08306b')
c2 <- colorRampPalette(c1)

legend_title_demo1 <- "Calves/Bulls per Cow"

# Prepare spatial data
ab_wmu_demo <- ab_wmu %>%
  mutate(WMU = as.numeric(WMU)) %>%
  # Full join in order to retain both Response types
  full_join(df_demo2, by = "WMU") %>%
  select(WMUNIT_NAM, WMU, StartYear:ratio) %>%
  mutate(bin = as.numeric(cut2(ratio, g = 10)),
         colour = c2(10)[bin]) %>%
  mutate(colour = if_else(is.na(colour), "#999999", colour))
  
# Map 1 (CalfCow)  
tm_map_demo1 <- ab_wmu_demo %>%
  filter(Response == "Calf:Cow" | is.na(Response)) %>%
  tm_shape() +
    tm_fill(col = "ratio",
            palette = c1,
            style = "cont",
            colorNA = "grey60",
            textNA = "Missing",
            title = legend_title_demo1) +
    tm_borders(col = "black") +
    tm_text("WMU", size = 0.65) +
  tm_compass(type = "4star", size = 2, 
             position = c("left", "bottom")) +
  tm_scale_bar(position = c("left", "bottom")) +
  tm_layout(title = "Calf:Cow", title.size = 1,
            legend.title.size = 1, frame = FALSE)

# Map 2 (BullCow)
tm_map_demo2 <- ab_wmu_demo %>%
  filter(Response == "Bull:Cow" | is.na(Response)) %>%
  tm_shape() +
    tm_fill(col = "colour",
            style = "cont") +
    tm_borders(col = "black") +
    tm_text("WMU", size = 0.65) +
  tm_layout(title = "Bull:Cow", title.size = 1,
            legend.title.size = 1, frame = FALSE)

# Combine two maps
# tm_map_demo_both <- tmap_arrange(tm_map_demo1, tm_map_demo2)

# tmap_save(tm_map_demo_both, filename = "./tmap_png/demo.png")

include_graphics("./png_files/demo.png")

```


### Survival

We extracted either adult or calf survival values from three reviewed documents
(9% of the total) for a combined 10 survival estimates. Calf survival was lower
than adult survival and was higher when estimated with GPS telemetry vs. radio
telemetry. 

Table?

***

## Distribution

The following section details research related to the distribution of moose in 
the OSR, such as predictions of moose relative abundance or density across 
various land cover types.

### Habitat Associations 

The ABMI uses data collected from RCs to estimate species-specific habitat 
models, and then uses these models to predict the relative abundance of each 
species across the landscape. Explanatory variables in these models include 
prevalance of nearby human footprint and native landcover, as well as spatial
and climate covariates. Models are estimated for two separate regions of the 
province, a north and a south region, and different combinations of covariates
are used for each. In this report, we consider only the north regional models.

Separate models are estimated for camera deployments during the 
summer and the winter, in order to account for differing detection rates as 
vegetation grows and obscures the camera field of view, as well as seasonal 
differences in species' habitat use patterns. Using RC data from 2015-2018,
these models were used to show how moose relative abundance differed among 
vegetation and human footprint in northern region (which is comprised of the
Boreal and Foothills natural regions) - see Figures X and X for the winter and 
summer models, respectively. Predicted moose abundance in each habitat type is 
shown with bars, and vertical lines indicate 90% confidence intervals. Only 
habitat and human footprint categories that are statistically separable are
displayed.

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE, out.width='100%'}

include_graphics("./png_files/Veg+HF_figure_MooseSummer.png")

include_graphics("./png_files/Veg+HF_figure_MooseWinter.png")

```

In the summer, the models of habitat association suggest that moose show a 
preference for shrub and grassland areas, as well as marshes. In addition, moose
prefer older deciduous forest, but younger mixedwood areas. In the winter, an
opposite preference for mixedwood is found. 

The ABMI uses these habitat association models, plus models describing how 
species vary spatially and with climate gradients, to predict species abundance
in 1 km$^2$ spatial units under both *current* and *reference* conditions. 
Current condition predictions are made based on the vegetation and human 
footprint currently present in each 1 km$^2$ unit, whereas reference condition
predictions are made after human footprint has been erased and the native 
vegetation 'backfilled' in the unit based on the surrounding area. Figure X



```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE}

# This is where we will likely want to connect to cure4insect once the package
# is updated and the mammal results have been uploaded.



```

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE, out.width="100%"}

# Interactive leaflet map

library(leafgl)

pixel_1km_aoi <- pixel_1km %>%
  separate(WMUNIT_COD, into = c("zeroes", "WMU"), sep = 2, remove = FALSE) %>%
  select(-zeroes) %>%
  select(GRID_LABEL, WMUNIT_NAM, WMU) %>%
  rename(LinkID = GRID_LABEL) %>%
  # Join in Moose prediction data
  left_join(abmi_pred, by = "LinkID") %>%
  # Set projection
  st_transform("+init=epsg:4326") %>%
  st_cast("POLYGON") %>%
  # Subset
  filter(!is.na(Curr)) %>%
  mutate(q_curr = as.numeric(cut2(Curr, g = 100))) %>%
  select(q_curr)

# Define colors

c1 <- c("blue", "white", "red")
c2 <- colorRampPalette(c1)
colours <- c2(100)[pixel_1km_aoi$q_curr]

colours1 <- (convert_colors(colours)) / 255

pal_2 <- colorNumeric(c("blue", "white", "red"),
                      domain = pixel_1km_aoi$q_curr)

map_2 <- 
  ab_wmu_dens %>%
  st_transform("+init=epsg:4326") %>%
  leaflet() %>%
  addTiles() %>%
  addProviderTiles("Stamen.TerrainBackground") %>%
  addProviderTiles("Esri.WorldImagery", group = "Imagery") %>%
  addFullscreenControl() %>%
  addResetMapButton() %>%
  addScaleBar(position = "bottomright", 
              options = scaleBarOptions(imperial = FALSE)) %>%
  setView(lng = -113.07, lat = 56.53, zoom = 7) %>%
  
  # Polygon layers
  addPolygons(color = "#070707", weight = 2,
              smoothFactor = 0.2, opacity = 2.0,
              popup = paste("WMU Name:", 
                            "<b>", ab_wmu_dens$WMUNIT_NAM, "</b>", "<br>",
                            "WMU Code:", 
                            "<b>", ab_wmu_dens$WMU, "</b>", "<br>",
                            "Moose Density:", 
                            "<b>", ab_wmu_dens$Density, "</b>", "per km2", "<br>", 
                            "<br>",
                            "<i>", "Last surveyed in", 
                            ab_wmu_dens$Survey_Year, "<i>")) %>%
  
  addGlPolygons(data = pixel_1km_aoi,
                color = colours1,
                group = "ABMI Relative Abundance Predictions",
                opacity = 0.75) %>%
  
  # Layers control
  addLayersControl(overlayGroups = c("Imagery", 
                   "ABMI Relative Abundance Predictions"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
  
  hideGroup("Imagery")
  
map_2



```

hello

Two other reviewed documents estimated moose density as a function of 
environmental variables. The first (Schneider et al. 2000) examined broad scale 
changes to moose density across Northern Alberta using random stratified block 
aerial surveys. Moose median densities increased from 0.25 per km2 in the green 
zone, which is characterized by forestry as the dominant land use, to 0.4 per 
km2 in the white zone, which is primarily agriculture and human settlement. 
Moose density was also found to be higher in the foothills and mixedwood regions. 
Schneider et al. (2000) also measured changes in moose density along gradients
of human activity and found that density was higher closer to the white zone and
with decreasing latitude. Ferguson and Keith (1982) found that, within 500 m of
either high or low use cross country ski trails in Elk Island National Park, 
moose density increased or decreased respectively, compared to farther than
500 m. 

## Behaviour

### Selection

### Use

### Home Range Area

# Discussion


# Impacts of various human footprint / landcover

Section with qualitative discussion regarding impacts of various HF, 
disturbance, and landcover on moose population parameters. 






















